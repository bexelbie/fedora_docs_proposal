<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Fedora Docs Toolchain Proposal Latest | Proposal | Proof of Concept (POC) | Build the Entire Site</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

   <!-- <link href="../../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css"> -->
  <!--[if IE]><link rel="shortcut icon" href="../../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://www.winglemeyer.org/"><img alt="winglemeyer.org" src="../../../latest/_images/winglemeyer.org-logo.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../../index.html">even the horse knew</a>
      </li>
      <li class="hidden-xs active">
        <a href="../../proposal/overview.html">Fedora Docs Toolchain Proposal Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../../proposal/overview.html">Proposal</a>
      </li>
      <li class="hidden-xs active"><a href="../../proposal/poc/install.html">Proof of Concept (POC)</a></li>
      <li class="hidden-xs active">
        Build the Entire Site
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-down"></span>Proposal
      </a>
      <ul id="topicGroup0" class="collapse in list-unstyled">
            <li><a class="" href="../../proposal/overview.html">Overview</a></li>
            <li><a class="" href="../../proposal/rationale.html">Why these Components?</a></li>
            <li><a class="" href="../../proposal/converting.html">Converting DocBook to AsciiDoc</a></li>
            <li><a class="" href="../../proposal/asciibinder.html">Converting Documentation Collections to AsciiBinder</a></li>
            <li><a class="" href="../../proposal/translation.html">Translating AsciiDoc</a></li>
            <li class="nav-header">
              <a class="" href="#" data-toggle="collapse" data-target="#topicSubGroup-0-5">
                <span id="sgSpan-0-5" class="fa fa-caret-down"></span>&nbsp;Proof of Concept (POC)
              </a>
              <ul id="topicSubGroup-0-5" class="nav-tertiary list-unstyled collapse in">
                  <li><a class="" href="../../proposal/poc/install.html">Pre-Requisites</a></li>
                  <li><a class="" href="../../proposal/poc/single-repo.html">Build one Book or Documentation Collection</a></li>
                  <li><a class=" active" href="../../proposal/poc/multi-repo.html">Build the Entire Site</a></li>
              </ul>
            </li>
            <li><a class="" href="../../proposal/nextsteps.html">Next Steps</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Build the Entire Site</h2>
        </div>
        <div class="sect1">
<h2 id="what-is-in-the-repository"><a class="anchor" href="#what-is-in-the-repository"></a>What is in the repository?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this Proof of Concept (POC), we will use the site configuration
repository, "docs-fp-asciibinder".  This repository contains no content,
therefore everything is stored on the master branch.</p>
</div>
<div class="paragraph">
<p>This repository is used as a template for building a full AsciiBinder
repository.  The template is used by the <code>builder.sh</code> script.  Therefore
these files are very specifically structured and may not be functional
until after the builder has been run.</p>
</div>
<div class="paragraph">
<p>This is the file tree for the <code>master</code> branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>.
|-- _distro_map.yml     <i class="conum" data-value="1"></i><b>(1)</b>
|-- _images             <i class="conum" data-value="2"></i><b>(2)</b>
|   `-- fedora.svg
|-- _javascripts        <i class="conum" data-value="2"></i><b>(2)</b>
|-- _stylesheets        <i class="conum" data-value="2"></i><b>(2)</b>
|   `-- asciibinder.css
|-- _templates          <i class="conum" data-value="2"></i><b>(2)</b>
|   |-- _css.html.erb
|   |-- _nav.html.erb
|   `-- page.html.erb
|-- _topic_map.yml      <i class="conum" data-value="3"></i><b>(3)</b>
|-- builder.sh          <i class="conum" data-value="4"></i><b>(4)</b>
|-- index-en-US.html    <i class="conum" data-value="5"></i><b>(5)</b>
`-- index-master.html   <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>_distro_map.yml</code> is used as a template for building out every
language.  The text, "en-US" is used as a replaceable in the builder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>These are still generic AsciiBinder files.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>_topic_map.yml</code> is dynamically generated by the builder.
This one is empty.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is the magic, see below</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is a template single language index file.  The text "en-US"
is used as a replaceable by the builder.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This is the actual, final, site index page.  For consistency with
the single book example, it is also ugly.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-does-it-work"><a class="anchor" href="#how-does-it-work"></a>How Does it Work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the Proof of concept, a builder has been written.  The builder follows
this algorithm to produce a repository that AsciiBinder can process.
This repository is temporary and should be deleted without being pushed
to a remote when the process is finished.</p>
</div>
<div class="paragraph">
<p>Today, the builder contains a lot of hardcoded values, such as which books
should be included.  These can be refactored out into a configuration
file.</p>
</div>
<div class="sect2">
<h3 id="algorithm"><a class="anchor" href="#algorithm"></a>Algorithm</h3>
<div class="paragraph">
<p>Note: Numbers in parenthesis refer to line numbers in the script.  The source is below</p>
</div>
<div class="paragraph">
<p>This script prepares a full site build.  For this POC, that is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>two books, the <em>Installation Guide</em> and the <em>Virtualization Getting
Started Guide</em> in English for all three versions of Fedora: Rawhide,
Fedora 24, and Fedora 23.</p>
</li>
<li>
<p>Japanese translations of all books and versions.</p>
</li>
<li>
<p>a French translation of just the <em>Installation Guide</em> for all versions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The goal is to generate this branch structure:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Language</th>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">Branch Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">English</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f23-adoc-en-US</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">English</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f24-adoc-en-US</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">English</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">master-adoc-en-US</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">French</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f23-adoc-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">French</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f24-adoc-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">French</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rawhide</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">master-adoc-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f23-adoc-ja</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">f24-adoc-ja</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rawhide</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">master-adoc-ja</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup the Common Content (33-36)</p>
<div class="paragraph">
<p>This loop shouldn&#8217;t be a loop right now. :). For now, we just add the
common content to the master-adoc branch so that when we clone the branch
we get common content for "free." This way all content shares a single
version of the common content.</p>
</div>
</li>
<li>
<p>Build the en-US branches first</p>
</li>
<li>
<p>Create an en-US branch named "&lt;version&gt;-en-US" (44)</p>
</li>
<li>
<p>Add each book into the <code>_git</code> directory (46-50)</p>
</li>
<li>
<p>Create the content directories for AsciiBinder by linking in the
<code>en-US</code> dir from each book. (55-56)</p>
</li>
<li>
<p>Extend the <code>_topic_map.yml</code> with the topics from each book. (58-62)</p>
</li>
<li>
<p>Clean up includes (really needed later for other languages) (65)</p>
</li>
<li>
<p>Commit this to the language branch (68-69)</p>
</li>
<li>
<p>Build out the languages</p>
</li>
<li>
<p>Create a language branch (77-82)</p>
</li>
<li>
<p>Add each book for that language into the <code>_git</code> directory (85-88)</p>
</li>
<li>
<p>Link in the content, but change the name of the link to match the
language. (94)</p>
</li>
<li>
<p>Extend the <code>_topic_map.yml</code> with the topics from each book, updating
the directory name. (96-100)</p>
</li>
<li>
<p>Update include links with the new direction name. (103)</p>
</li>
<li>
<p>Pull the <code>.po</code> files from Zanata. <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup> Store
them in the <code>pot</code> directory. (106)</p>
</li>
<li>
<p>Apply the translations and update the source files using <code>po4a</code>
(108-115)</p>
</li>
<li>
<p>Commit this to the language branch (117-120)</p>
</li>
<li>
<p>Build out the <code>_distro_map.yml</code> (127-137)</p>
<div class="paragraph">
<p>This allows AsciiBinder to know about all of the "version-language" branches.</p>
</div>
</li>
<li>
<p>Make a final commit (141-142)</p>
</li>
<li>
<p>Build the site (145)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="build-sh"><a class="anchor" href="#build-sh"></a>build.sh</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>  1	#!/bin/bash
  2
  3	# Preprocessor to setup the asciibinder repository
  4
  5	# To Do:
  6	# * This should read _distro_map.yml and something like _git_map.yml to dynamically generate itself
  7	# * Cleanup the publishing branches when we start
  8	# * Write a reset script
  9	# * This needs to link to the proper translation of Common_Content
 10
 11	# This assume a ~/.config/zanata.ini with user credentials
 12
 13	zanataurl=https://fedora.zanata.org
 14	zanataproject=docs-sandbox
 15
 16	LANGS="ja
 17	fr"
 18
 19	BRANCHES="master-adoc
 20	f24-adoc
 21	f23-adoc"
 22
 23	BOOKS="bex-install-guide
 24	bex-virt-getting-started-guide"
 25
 26	ja_BOOKS="bex-install-guide
 27	bex-virt-getting-started-guide"
 28
 29	fr_BOOKS="bex-install-guide"
 30
 31	DATE=`date`
 32
 33	# Set up Common Content
 34	for branch in $BRANCHES; do
 35	    git subtree add --prefix _Common_Content https://pagure.io/docs-common-content.git master-adoc --squash
 36	done
 37
 38	# First build out en-US
 39	for lang in "en-US"; do
 40	    for branch in $BRANCHES; do
 41	        langbranch=$branch-$lang
 42
 43	        git checkout $branch
 44	        git checkout -b $langbranch
 45
 46	        # Get books
 47	        for book in $BOOKS; do
 48	            # Book Source into _git
 49	            git subtree add --prefix _git/$book https://pagure.io/$book.git $branch --squash
 50	        done
 51
 52	        # Preprocess the books (this ordering prevents having to have a commit in every pass)
 53	        for book in $BOOKS; do
 54	            # Link in the baselang to the root directory
 55	            dir=`echo $book | sed -e 's/bex-//'` # Temporary because using my repos
 56	            ln -s _git/$book/en-US $dir
 57
 58	            # Update the _topic_map.yml
 59	            cp _git/$book/_topic_map.yml temp_topic_map.yml
 60	            sed -i -e "s/^Dir: en-US/Dir: $dir/" temp_topic_map.yml
 61	            cat temp_topic_map.yml &gt;&gt; _topic_map.yml
 62	            rm temp_topic_map.yml
 63
 64	            # Update include links in the books (find -L follows symlinks)
 65	            find -L $dir -iname *.adoc  | xargs -I FILE sed -i -e "s/include::en-US/include::$dir/  " FILE
 66
 67	            # Commit it all baby
 68	            git add .
 69	            git commit -m "Build on $DATE"
 70	        done
 71	    done
 72	done
 73
 74	# Now try the languages
 75	for lang in $LANGS; do
 76	    for branch in $BRANCHES; do
 77	        langbranch=$branch-$lang
 78	        langbooksvar=$lang\_BOOKS
 79	        langbooks=${!langbooksvar}
 80
 81	        git checkout $branch
 82	        git checkout -b $langbranch
 83
 84	        # Get books
 85	        for book in $langbooks; do
 86	            # Book Source into _git
 87	            git subtree add --prefix _git/$book https://pagure.io/$book.git $branch --squash
 88	        done
 89
 90	        # Preprocess the books (this ordering prevents having to have a commit in every pass)
 91	        for book in $langbooks; do
 92	            # Link in the baselang to the root directory
 93	            dir=`echo $book | sed -e 's/bex-//'` # Temporary because using my repos
 94	            ln -s _git/$book/en-US $dir
 95
 96	            # Update the _topic_map.yml
 97	            cp _git/$book/_topic_map.yml temp_topic_map.yml
 98	            sed -i -e "s/^Dir: en-US/Dir: $dir/" temp_topic_map.yml
 99	            cat temp_topic_map.yml &gt;&gt; _topic_map.yml
100	            rm temp_topic_map.yml
101
102	            # Update include links in the books (find -L follows symlinks)
103	            find -L $dir -iname *.adoc  | xargs -I FILE sed -i -e "s/include::en-US/include::$dir/  " FILE
104
105	            # Pull the .pot files
106	            zanata pull --url $zanataurl --project-id $zanataproject --project-version $dir --lang $lang --transdir pot/ --project-type podir
107
108	            # Apply the translations
109	            # Right now this accepts all percentages of translation
110	            # -L makes find follow symlinks
111
112	            for file in $( find -L $dir -name "*.adoc" ); do
113	                basename=`basename -s .adoc $file`
114	                po4a-translate -f asciidoc -m $file -l $file -p pot/$lang/$basename.po -M UTF-8 -k 0
115	            done
116
117	            # Commit it all baby
118	            date=`date`
119	            git add .
120	            git commit -m "Build on $date"
121	        done
122	    done
123	done
124
125	git checkout master-adoc
126
127	# Build out _distro_map.yml
128	for lang in $LANGS; do
129	    # Entries in _distro_map.yml
130	    cp _distro_map.yml temp_distro_map.yml
131	    sed -i -e "s/en-US/$lang/g" temp_distro_map.yml
132	    sed -i -e "s/^--*$//" temp_distro_map.yml
133	    cat temp_distro_map.yml &gt;&gt; _distro_map.yml
134	    rm temp_distro_map.yml
135
136	    # index page
137	    cp index-en-US.html index-$lang.html
138	done
139
140	# Build commit
141	git add .
142	git commit -m "Build on $DATE"
143
144	asciibinder package
145	cp index-master.html _package/index.html</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="looking-at-the-output"><a class="anchor" href="#looking-at-the-output"></a>Looking at the Output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Build the site using the <code>builder.sh</code> script from the `master-adoc"
branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>git checkout master-adoc
./builder.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: The Zanata slows, in particular are slow.  This takes approximately
30 minutes to complete.  Some caching will speed this up.</p>
</div>
<div class="paragraph">
<p>To view the output, use your web browser to open the file
<code>_package/index.html</code>.</p>
</div>
<div class="paragraph">
<p>The ugly index page will let you choose a version to preview.  I suggest
you start with the Rawhide English version.  Because I have not added a
language switcher, to change languages you should use your back button
to return to the index page you opened above.</p>
</div>
<div class="paragraph">
<p>At some point, take a look at the "Kickstart Syntax Reference" and scroll
down a little bit to see a line that reads:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ ksverdiff -f F23 -t F24</code></pre>
</div>
</div>
<div class="paragraph">
<p>This line uses the macros for the current and previous versions of the
product.  Now look at the same file in Fedora 24 and Fedora 23 and see
the difference.</p>
</div>
<div class="paragraph">
<p>The translations are incomplete, but you can see them in action on
many pages.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. This is slow.
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>